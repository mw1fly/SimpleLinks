<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="css/style.css">
<title>SimpleLinks Admin Panel</title>
<style>
  body { font-family: sans-serif; margin: 20px; background-color: #111; color: white; }
  input, button, select { margin: 5px; padding: 8px; }
  h1, h2 { text-align: center; }
  form { margin-bottom: 20px; }
  #linksTable { width: 100%; border-collapse: collapse; margin-top: 20px; }
  #linksTable td, #linksTable th { border: 1px solid #444; padding: 8px; text-align: left; }
  #linksTable th { background-color: #222; }
  #linksTable img { max-width: 80px; }
  #editPanel { background: #222; padding: 10px; margin-top: 20px; border: 1px solid #666; }

/* make links in the grid more visible */

a:link {
  color: red;
}

/* visited link */
a:visited {
  color: green;
}

/* mouse over link */
a:hover {
  color: hotpink;
}

/* selected link */
a:active {
  color: blue;
}

/* admin panel table tweaks */
#linksTable td, #linksTable th {
    border: 1px solid #444;
    padding: 4px 6px;  /* reduce padding */
    text-align: left;
    vertical-align: middle;  
}
/* Style the Actions column as a 2x2 grid */

#linksTable td.actions {
    text-align: center;
    vertical-align: middle;
}

#linksTable td.actions div {
    display: grid;
    grid-template-columns: repeat(2, auto);
    gap: 4px;  /* spacing between buttons */
    justify-content: center;
}

#linksTable td.actions button {
    padding: 4px 6px;
    font-size: 12px;
    min-width: 50px; /* keep consistent size */
}


/* align content vertically */
#/* Make image cells consistent and centered           *** Best so far *** */
##linksTable td:nth-child(4) {
#    text-align: center;       /* center image in its cell */
#    width: 120px;             /* reserve space for thumbnails */
#    vertical-align: middle;   /* align with row content */
#}
#
##linksTable img {
#    max-width: 100px;         /* limit thumbnail size */
#    max-height: 80px;         /* control row height */
#    display: inline-block;    /* don’t force block layout */
#    object-fit: contain;      /* scale without distortion */
#    margin: 2px auto;         /* small vertical spacing */
#}

form input, form button {
    margin: 2px 4px;
    padding: 6px 8px;
    font-size: 14px;
}
#linksTable td > button {
    display: inline-block;   /* make buttons sit horizontally */
    margin: 0 2px;           /* small horizontal spacing */
    padding: 4px 6px;        /* reduce button size */
    font-size: 12px;         /* smaller text */
}

</style>
</head>
<body>

<h1>SimpleLinks Admin Panel</h1>

<!-- Search Engines Management -->
<h2>Search Engine Settings</h2>
<form id="engineForm">
  <label for="activeEngineSelect">Select Engine</label>
  <select id="activeEngineSelect"></select>
  <!-- Dropdown to select active engine -->
  <button type="button" id="setActiveEngine">Set Active</button>

  <label for="engineName">Name</label>
  <input type="text" id="engineName">

  <label for="engineURL">Search URL</label>
  <input type="text" id="engineURL">

  <label for="engineLogo">Logo Path</label>
  <input type="text" id="engineLogo">

  <button type="submit">Add / Update Engine</button>
  <button type="button" id="deleteEngine">Delete Engine</button>

</form>
<!-- Add Link Form -->
<h2>Add Link</h2>
<form id="addForm">
  <input type="text" id="url" placeholder="URL" required>
  <input type="text" id="type" placeholder="Type">
  <input type="text" id="comment" placeholder="Comment">
  <input type="file" id="imageFile" accept="image/*">
  <select id="existingImage"></select>
  <button type="submit">Add Link</button>
</form>

<!-- Current Links -->
<h2>Current Links</h2>
<table id="linksTable">
  <thead>
    <tr>
      <th>URL</th>
      <th>Type</th>
      <th>Comment</th>
      <th>Image</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Edit Panel Modal -->
<div id="editPanel" class="modal">
  <div class="modal-content">
    <h3>Edit Link</h3>
    <input type="hidden" id="editIndex">
    <label for="editUrl">URL</label>
    <input type="text" id="editUrl" placeholder="URL"><br>
    <label for="editType">Type</label>    
    <input type="text" id="editType" placeholder="Type"><br>
    <label for="editComment">Comment</label>    
    <input type="text" id="editComment" placeholder="Comment"><br>
    <label for="editFile">Upload New Image</label>    
    <input type="file" id="editFile" accept="image/*"><br>
    <label for="editImage">Choose Existing Image</label>    
    <select id="editImage"></select><br><br>
    <button onclick="saveEdit()">Save</button>
    <button onclick="closeEdit()">Cancel</button>
  </div>
</div>

<style>
  .modal {
    display: none; 
    position: fixed; 
    z-index: 1000; 
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.7);
  }
  .modal-content {
    background: #222;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #666;
    width: 400px;
    color: white;
    border-radius: 8px;
  }
/* Form styling for add/edit panels */
.modal-content label {
    display: block;        /* put label on its own line */
    margin-top: 8px;       /* spacing above each label */
    font-weight: bold;     /* make it stand out */
    font-size: 13px;
    color: #ddd;           /* lighter text for dark mode */
}

.modal-content input,
.modal-content select {
    width: 100%;           /* make inputs stretch across panel */
    padding: 6px 8px;
    margin-top: 2px;       /* small gap below label */
    border: 1px solid #444;
    border-radius: 4px;
    background: #222;
    color: #eee;
    font-size: 14px;
}

</style>
<script>
async function loadEngines() {
  // Fetch current config
  const resp = await fetch("/config");
  const cfg = await resp.json();
  const engines = cfg.search?.engines || [];
  const current = cfg.search?.engine || "";

  const select = document.getElementById("activeEngineSelect");
  const nameInput = document.getElementById("engineName");
  const urlInput = document.getElementById("engineURL");
  const logoInput = document.getElementById("engineLogo");

  // Populate dropdown
  select.innerHTML = "";
  engines.forEach(e => {
    const opt = document.createElement("option");
    opt.value = e.name;
    opt.textContent = e.name;
    if (e.name === current) opt.selected = true;
    select.appendChild(opt);
  });

  // Show selected engine details
  const selectedEngine = engines.find(e => e.name === current) || {};
  nameInput.value = selectedEngine.name || "";
  urlInput.value = selectedEngine.url || "";
  logoInput.value = selectedEngine.logo || "";

  // Update textboxes when selection changes
  select.addEventListener("change", () => {
    const engine = engines.find(e => e.name === select.value) || {};
    nameInput.value = engine.name || "";
    urlInput.value = engine.url || "";
    logoInput.value = engine.logo || "";
  });
}

// Add / Update engine
document.getElementById("engineForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = document.getElementById("engineName").value.trim();
  const url = document.getElementById("engineURL").value.trim();
  const logo = document.getElementById("engineLogo").value.trim();

  const resp = await fetch("/config/engines", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, url, logo })
  });

  if (resp.ok) {
    loadEngines();
    alert("Engine added/updated!");
  } else {
    alert("Failed to add/update engine");
  }
});

// Delete selected engine
document.getElementById("deleteEngine").addEventListener("click", async () => {
  const select = document.getElementById("activeEngineSelect");
  const name = select.value;
  if (!name) return;
  if (!confirm(`Delete engine "${name}"?`)) return;

  const resp = await fetch(`/config/engines/${encodeURIComponent(name)}`, {
    method: "DELETE"
  });

  if (resp.ok) {
    loadEngines();
    alert("Engine deleted!");
  } else {
    alert("Failed to delete engine");
  }
});

// Set active engine
document.getElementById("setActiveEngine").addEventListener("click", async () => {
  const select = document.getElementById("activeEngineSelect");
  const selected = select.value;
  if (!selected) return;

  const resp = await fetch("/config/active", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ engine: selected })
  });

  if (resp.ok) {
    alert(`Active engine set to ${selected}`);
    loadEngines();       // refresh dropdown + fields
    if (typeof setupSearchBar === "function") {
      setupSearchBar();  // refresh topnav logo + search
    }
  } else {
    alert("Failed to set active engine");
  }
});

// Initial load
window.addEventListener("DOMContentLoaded", loadEngines);
</script>

// Links 

<script>
// --- Load existing images into Add Link form ---
async function loadImageOptions() {
  const resp = await fetch("/images-list");
  const images = await resp.json();
  const select = document.getElementById("existingImage");
  select.innerHTML = `<option value="">-- choose existing --</option>`;
  images.forEach(img => {
    const option = document.createElement("option");
    option.value = img;
    option.textContent = img.split("/").pop();
    select.appendChild(option);
  });
}

// --- Load links into table ---
async function loadLinks() {
  const resp = await fetch("/links");
  const links = await resp.json();
  const tbody = document.querySelector("#linksTable tbody");
  tbody.innerHTML = "";
  links.forEach((link, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><a href="${link.url}" target="_blank">${link.url}</a></td>
      <td>${link.type || ""}</td>
      <td>${link.comment || ""}</td>
      <td>${link.image ? `<img src="${link.image}">` : ""}</td>
      <td class="actions">
        <div>
          <button onclick="showEdit(${idx})">Edit</button>
          <button onclick="deleteLink(${idx})">Delete</button>
          <button class="moveUp" data-index="${idx}">↑</button>
          <button class="moveDown" data-index="${idx}">↓</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// --- Add Link ---
document.getElementById("addForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const url = document.getElementById("url").value;
  const type = document.getElementById("type").value;
  const comment = document.getElementById("comment").value;
  const fileInput = document.getElementById("imageFile");
  let imagePath = document.getElementById("existingImage").value;

  // If uploading a new file
  if (fileInput.files.length > 0) {
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    const uploadResp = await fetch("/upload", { method: "POST", body: formData });
    if (uploadResp.ok) {
      const result = await uploadResp.json();
      imagePath = result.path;
    } else {
      alert("Image upload failed");
      return;
    }
  }

  if (!imagePath) imagePath = "images/default.png";

  const addResp = await fetch("/links", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ url, type, comment, image: imagePath })
  });

  if (addResp.ok) {
    loadLinks();
    document.getElementById("addForm").reset();
    loadImageOptions();
  } else {
    alert("Failed to add link");
  }
});

// --- Delete Link ---
async function deleteLink(index) {
  if (!confirm("Delete this link?")) return;
  const resp = await fetch(`/links/${index}`, { method: "DELETE" });
  if (resp.ok) loadLinks();
  else alert("Failed to delete link");
}

// --- Show Edit Panel ---
function showEdit(index) {
  fetch("/links").then(r => r.json()).then(async links => {
    const link = links[index];
    if (!link) return;

    document.getElementById("editPanel").style.display = "block";
    document.getElementById("editIndex").value = index;
    document.getElementById("editUrl").value = link.url;
    document.getElementById("editType").value = link.type;
    document.getElementById("editComment").value = link.comment;

    // Populate image dropdown
    const select = document.getElementById("editImage");
    const imagesResp = await fetch("/images-list");
    const images = await imagesResp.json();
    select.innerHTML = `<option value="">-- none --</option>`;
    images.forEach(img => {
      const option = document.createElement("option");
      option.value = img;
      option.textContent = img.split("/").pop();
      select.appendChild(option);
    });
    select.value = link.image || "";
  });
}

function closeEdit() {
  document.getElementById("editPanel").style.display = "none";
}

// --- Save Edit ---
async function saveEdit() {
  const index = document.getElementById("editIndex").value;
  let imagePath = document.getElementById("editImage").value;

  const fileInput = document.getElementById("editFile");
  if (fileInput.files.length > 0) {
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    const uploadResp = await fetch("/upload", { method: "POST", body: formData });
    if (uploadResp.ok) {
      const result = await uploadResp.json();
      imagePath = result.path;
    } else {
      alert("Image upload failed");
      return;
    }
  }

  if (!imagePath) imagePath = "images/default.png";

  const updateResp = await fetch(`/links/${index}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      url: document.getElementById("editUrl").value,
      type: document.getElementById("editType").value,
      comment: document.getElementById("editComment").value,
      image: imagePath
    })
  });

  if (updateResp.ok) {
    document.getElementById("editPanel").style.display = "none";
    loadLinks();
    loadImageOptions();
  } else {
    alert("Failed to update link");
  }
}


async function moveLink(index, direction) {
  const resp = await fetch(`/links/${index}/move`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ direction })
  });
  if (resp.ok) loadLinks(); // refresh table
  else alert("Move failed");
}

// Add event delegation
document.querySelector("#linksTable tbody").addEventListener("click", (e) => {
  if (e.target.classList.contains("moveUp")) {
    const index = parseInt(e.target.dataset.index);
    moveLink(index, "up");
  }
  if (e.target.classList.contains("moveDown")) {
    const index = parseInt(e.target.dataset.index);
    moveLink(index, "down");
  }
});



// --- Initial load ---
window.addEventListener("DOMContentLoaded", () => {
  loadLinks();
  loadImageOptions();
});
</script>

</body>
</html>
